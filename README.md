# ðŸš€ Transformer Fault Diagnosis
<p align="center"><em>Detect, diagnose, and stress-test multi-link aerial robots with Transformer-based Fault Detection & Isolation (FDI).</em></p>

<p align="center">
  <a href="https://www.python.org/" title="Python official site">
    <img src="https://img.shields.io/badge/python-3.10+-3776AB?logo=python&logoColor=white" />
  </a>
  <a href="https://pytorch.org/" title="PyTorch official site">
    <img src="https://img.shields.io/badge/pytorch-2.4-EE4C2C?logo=pytorch&logoColor=white" />
  </a>
  <a href="https://github.com/dnbn/transformer_fault_diagnosis" title="LASDRA dynamics code in this repo">
    <img src="https://img.shields.io/badge/robotics-LASDRA%20Dynamics-yellow?logo=github" />
  </a>
  <a href="#3-end-to-end-workflow" title="NPZ shard generation workflow">
    <img src="https://img.shields.io/badge/data-NPZ%20Shards-blue" />
  </a>
</p>

---

# ðŸ“š Table of Contents
- [1. Overview](#1-overview)
- [2. Project Structure](#2-project-structure)
- [3. End-to-End Workflow](#3-end-to-end-workflow)
- [4. Key Python Modules](#4-key-python-modules)
- [5. Installation](#5-installation)
- [6. Visualization Tools](#6-visualization-tools)
- [7. Checkpoints & Logs](#7-checkpoints--logs)
- [8. Technical Stack](#8-technical-stack)

---

# 1. Overview
This repository provides a **complete pipeline** for generating, training, evaluating, and visualizing **motor fault diagnosis** for a Large-Size Aerial Skeleton System with Distributed Rotor Actuation (**LASDRA**).

âœ¨ Highlights  
- ðŸ› ï¸ Automatic **fault injection** (motor dropout)  
- ðŸ”¥ **Transformer / Graph-Transformer** architectures  
- ðŸŽ¯ **Three-level FDI**  
  - **L1** â€” fault detection  
  - **L2** â€” faulty link identification  
  - **L3** â€” faulty motor identification  
- ðŸ§  Causal temporal windows + K-of-N **one-way latch**  
- ðŸŽžï¸ 3D visualization (robot, motors, fault bars)  
- ðŸ“Š Per-motor time-series fault visualization  
- ðŸ§ª Dataset integrity checkers (NaN/Inf, SE(3) validity)  
- âš¡ CUDA optimized: AMP, caching, memory-efficient operations  

---

# 2. Project Structure
```
transformer_fault_diagnosis/
â”œâ”€â”€ data_generate/               # Multi-process dataset generation
â”‚   â””â”€â”€ data_generate.py
â”œâ”€â”€ dynamics/                    # Forward kinematics + LASDRA rigid-body dynamics
â”œâ”€â”€ control/                     # PID controller + L_inf thrust allocator
â”œâ”€â”€ planning/                    # Closed-loop IK + trajectory planner
â”œâ”€â”€ graph_fdi_train.py           # Graph-Transformer FDI training (MAIN)
â”œâ”€â”€ fault_injection.py           # Fault injector
â”œâ”€â”€ fault_injection_fast.py      # Faster implementation
â”œâ”€â”€ motor.py                     # Motor geometry builder â†’ motor_geom.npz
â”œâ”€â”€ parameters.py                # True physical parameters
â”œâ”€â”€ parameters_model.py          # Model mismatch perturbation parameters
â”œâ”€â”€ data_storage/                # Generated datasets (shards)
â”œâ”€â”€ cache_frames/                # Cached link states (auto-created)
â”œâ”€â”€ cache_features/              # Cached graph features (auto-created)
â”œâ”€â”€ check_dataset_NaN_inf.py     # NaN/Inf integrity validator
â”œâ”€â”€ check_dataset_SE3.py         # SE(3) validator
â”œâ”€â”€ check_dataset_SE3_new.py     # Extended checks
â”œâ”€â”€ visualize_graph_fdi_motor_timeseries.py   # Motorwise fault timeline
â”œâ”€â”€ visualize_lasdra.py          # 3D robot + bar chart visualization
â”œâ”€â”€ save_znorm.py                # Global Z-normalization stats
â”œâ”€â”€ linf_nullspace_alloc.py      # L_inf nullspace thrust allocator
â””â”€â”€ requirements.txt
```

### Auto-generated folders & files  (after data_generation / training / preprocessing)

- `Link{N}_All/`
  All checkpoints for **link N** are stored here:
  - `best_graph_fdi.pth`      (best val-loss model)
  - `last_graph_fdi.pth`      (last epoch model)
  - `ckpt_epoch_new_{epoch}.pth`  (epoch-wise checkpoints)

- `GraphFDI_Transformer_L{N}/`
  Final consolidated GraphFDI model for **link N** and related stats:
  - `GraphFDI_Transformer_L{N}.pth`   (merged model used by visualizers)
  - `znorm_link{N}.npz`               (global Z-Norm `mu` / `std` for link-node 9D features,  
                                       generated by `save_znorm_l3.py` and used by
                                       `visualize_graph_fdi_motor_timeseries.py` / `visualize_lasdra.py`)

- `cache_L{N}/`
  Cached temporal windows, link states, and graph features  
  (used for faster training & visualization; created when `--cache_windows 1`).

- `data_storage/link_{N}/fault_dataset_shard_*.npz`
  Automatically generated fault datasets (shards) from `data_generate_new.py`.

- `motor_geom_link{N}.npz`
  Motor geometry for LASDRA with **N links**  
  (generated by `save_motor_geom.py`; contains `rotvec_m2l`, `r_mL`, `f_dir`, `arm` and is
  used by training/visualization via the `--motor_geom` argument).


---

# 3. End-to-End Workflow

## âœ” Step 0 â€” Generate Motor Geometry (Required for Graph-FDI)

Before training the Graph-Transformer FDI model, you must first generate the **motor geometry file** for a LASDRA robot with **N links**.

Run:
```bash
python3 motor.py
```
You will be prompted:

How many links? :

Enter the number of links (e.g., 1, 2, 3, or 4).

This will create:
```
motor_geom_link{N}.npz
```
Contents of motor_geom_link{N}.npz:

- rotvec_m2l â€” (L, 8, 3) motor â†’ link rotation vectors  
- r_mL â€” (L, 8, 3) motor mounting positions  
- f_dir â€” (L, 8, 3) normalized thrust directions  
- arm â€” (L, 8) torque arm lengths  

These values are required for:
- Graph-FDI training (--motor_geom motor_geom_link{N}.npz)
- All Graph-FDI visualizers (3D robot, motor bars, motor-wise timelines)


## âœ”ï¸ Step 1 â€” Dataset Generation
```bash
python3 data_generate/data_generate.py
```
Prompts (with recommended values):
- Link count â€” 1, 2, 3, or 4 â€¦
- Sequence length T â€” 1000 recommended
- #Samples â€” multiples of 1000 (e.g., 1000 / 2000 / 5000 â€¦)
- #Workers â€” 0 (max CPU) â€” adjust based on your CPU specs
- eps scale â€” 0 recommended [for bias, put non zero value. (e.g., 0.01)]
- Bypass BÂ·Î» before first fault (y/n) â€” n (important!)

Output:
```
data_storage/link_{N}/fault_dataset_shard_00001.npz
```
Sharding ensures large datasets donâ€™t exceed RAM.

## âœ”ï¸ Step 2 â€” Dataset Validation
ðŸ” NaN / Inf check
```bash
python3 check_dataset_NaN_inf.py
```
ðŸ” SE(3) structure check
```bash
python3 check_dataset_SE3.py
python3 check_dataset_SE3_new.py
```
ðŸ” Ï„ â‰ˆ Dáµ€Â·B_blkdiagÂ·Î» (Torque Distribution Chain Consistency Check)
```bash
python3 check_tau_equals_Blambda_chain.py \
  --links 3 \
  --trials 50
```

## âœ”ï¸ Step 3 â€” Train Models
ðŸš€ Graph-Transformer FDI (recommended; SOTA)
```bash
python3 graph_fdi_train.py \
  --data_dir ./data_storage/link_{N} \
  --shard_first 1 --shard_last 5 \
  --device auto \
  --batch_size 16 --epochs 80 \
  --num_workers 0 \
  --motor_geom ./motor_geom_link{N}.npz \
  --temporal transformer \
  --T_win 128 --stride 64 \
  --d_model 384 --heads 6 --depth 5 \
  --dropout 0.05 \
  --apply_post \
  --post_k 3 --post_n 5 \
  --post_up 0.6 --post_down 0.4 \
  --cache_windows 1 \
  --cache_dir ./cache_L{N} \
  --cache_dtype fp32 \
  --amp 1 \
  --lambda_l1 1.0 --lambda_l2 1.0 --lambda_l3 1.0 \
  --motor_freeze_epochs 6 \
  --label_smoothing 0.05
```
Key flags:
- `--data_dir`, `--motor_geom`, `--cache_dir`: replace `{N}` with link count (e.g., `1`, `2`, `3`, `4`).
- `--num_workers`: `0` on WSL or small CPUs; increase up to your CPU core count if you want faster loading.
- `--motor_geom`: enables motor-node features using `motor_geom_link{N}.npz`.
- `--apply_post`: one-way latch post-processing on onset probabilities (K-of-N, no reset to normal).
- `--cache_windows`: builds & uses frame cache (first epoch a bit slower, later epochs ~3Ã— faster).
- Checkpoints are saved automatically under `Link{N}_All/` (all epochs) and `GraphFDI_Transformer_L{N}/` (final model).

âš™ï¸ GPU Load Tuning (IMPORTANT)
- Monitor in real time: `watch -n 0.5 nvidia-smi`
- Target GPU load: **80â€“95%** for best throughput.
- If usage > 99%: reduce `batch_size`, lower `num_workers`, optionally shrink model.
- If usage < 50%: increase `batch_size`; raise `num_workers` (WSL: keep 0; Linux: start at 4 or half your cores).
- Batch size hints: VRAM â‰¥ 12GB â†’ start 16; VRAM â‰ˆ 8GB â†’ start 4â€“8; tune to stay in 80â€“95% range.
- Rationale: Graph-FDI is heavy on spatial-temporal Transformer compute; balance CPUâ†’GPU feed (`num_workers`) with GPU load (`batch_size`) to avoid stalls or overloads.

### ðŸ“„ Save Global Z-Norm (mu, std)
After training, compute the global Z-Norm parameters (mu, std) used by `LASDRAFDIDataset`. This scans all shards and saves the normalization file inside `GraphFDI_Transformer_L{N}/`:
```bash
python3 save_znorm.py \
  --ckpt /home/user/transformer_fault_diagnosis/GraphFDI_Transformer_L{N}/GraphFDI_Transformer_L{N}.pth \
  --data_dir /home/user/transformer_fault_diagnosis/data_storage/link_{N} \
  --shard_first 1 --shard_last 5 \
  --motor_geom /home/user/transformer_fault_diagnosis/motor_geom_link{N}.npz
```
The script rebuilds the same `LASDRAFDIDataset` (normalize=True), recomputes global stats for the 9-D link-node features, and saves:
```
GraphFDI_Transformer_L{N}/znorm_link{N}.npz
```
This file is required for streaming inference, visualizers, and deployment scripts.


---

# 4. Key Python Modules
- ðŸŒ€ `motor.py` â€” Builds rotor geometry (offsets, torque arms, rotvecs).
- ðŸ§ª `data_generate/data_generate.py` â€” Simulates LASDRA dynamics, PID control, thrust allocation, and injects faults.
- âš¡ `fault_injection_fast.py` â€” Efficient motor-fault injector.
- ðŸ§© `parameters.py` â€” True physical parameters (mass, inertia, PID gains).
- ðŸ§ª `parameters_model.py` â€” Perturbed model parameters for mismatch experiments.
- ðŸŽ›ï¸ `control/centralized_controller.py` â€” Centralized PID mapping pose error â†’ link wrenches.
- ðŸ”§ `control/external_actuation.py` â€” Global/per-link L_inf thrust allocation using nullspace optimization.
- ðŸ”¢ `dynamics/forward_kinematics_class.py` â€” SE(3) transforms, Jacobians, joint chains.
- ðŸ§  `graph_fdi_train.py` â€” Main training script (multi-level losses, frame/feature cache, K-of-N latch, CSV logging, AMP/TF32).
- ðŸ“ˆ `visualize_graph_fdi_motor_timeseries.py` â€” Plots GT vs Prediction for all motors.
- ðŸŽžï¸ `visualize_lasdra.py` â€” 3D robot render + fault bar charts.
- ðŸ”¢ `save_znorm.py` â€” Computes & exports global Z-norm stats (required for consistent inference).

---

# 5. Installation
```bash
pip install -r requirements.txt
```
Recommended:
- Python 3.10+
- PyTorch 2.4.0 (CUDA 12.1 wheel provided by pip)
- Core dependencies (see `requirements.txt`):
  - numpy, scipy, pandas, tqdm, matplotlib
  - networkx, einops, pyquaternion, trimesh, scikit-spatial, PyYAML
  - torch==2.4.0, torchvision==0.19.0, torchaudio==2.4.0
  - `--extra-index-url https://download.pytorch.org/whl/cu121`

---

# 6. Visualization Tools
ðŸ“‰ Per-motor timeline (link count = {N})
```bash
python3 visualize_graph_fdi_motor_timeseries.py \
  --ckpt GraphFDI_Transformer_L{N}/ckpt_epoch_new_080.pth \
  --data_dir data_storage/link_{N} \
  --shard_first 1 --shard_last 5 \
  --motor_geom motor_geom_link{N}.npz \
  --out result_plot.png
```

ðŸŽ¥ 3D LASDRA animation (quick preview)
```bash
python3 visualize_lasdra.py \
  --ckpt GraphFDI_Transformer_L{N}/ckpt_epoch_new_080.pth \
  --data_dir data_storage/link_{N} \
  --seq_idx 0 \
  --motor_geom motor_geom_link{N}.npz \
  --out demo.mp4
```

ðŸŽ¬ Save 3D LASDRA Fault Visualization Video (full path example)
```bash
python3 visualize_lasdra.py \
  --ckpt /home/user/transformer_fault_diagnosis/GraphFDI_Transformer_L{N}/GraphFDI_Transformer_L{N}.pth \
  --data_dir /home/user/transformer_fault_diagnosis/data_storage/link_{N} \
  --znorm /home/user/transformer_fault_diagnosis/GraphFDI_Transformer_L{N}/znorm_link{N}.npz \
  --shard_first 1 --shard_last 6 \
  --seq_idx 5000 \
  --motor_geom /home/user/transformer_fault_diagnosis/motor_geom_link{N}.npz \
  --theta_motor 0.8 \
  --kofn_k 8 \
  --kofn_n 10 \
  --save_video 1 \
  --out /home/user/transformer_fault_diagnosis/lasdra_vis_link{N}.mp4 \
  --video_fps 60 \
  --dpi 150
```

â± Compress video to 10s
```bash
python3 compress_to_10s.py --input demo.mp4 --output demo_10s.mp4
```

---

## 7. Checkpoints, Logs & Caches

| Path | Meaning |
| --- | --- |
| `Link{N}_All/best_graph_fdi.pth` | Best validation loss checkpoint (used for final test evaluation). |
| `Link{N}_All/last_graph_fdi.pth` | Last epoch checkpoint. |
| `Link{N}_All/ckpt_epoch_new_XXX.pth` | Per-epoch checkpoints (for rollback / ablation). |
| `GraphFDI_Transformer_L{N}/GraphFDI_Transformer_L{N}.pth` | Final Graph-Transformer FDI model for link-`N` (used by streaming visualizers / deployment). |
| `GraphFDI_Transformer_L{N}/znorm_link{N}.npz` | Global Z-Norm parameters `(mu, std)` for 9-D link-node features (required at inference time). |
| `train_log.csv` | Per-epoch metrics (total loss, L1/L2/L3 losses, L1/L2/L3 accuracies, overall accuracy, learning rate). |
| `cache_frames/` | Frame-level cache of link features (`node_link`, `edge_link`) used to speed up training. |


---

# 8. Technical Stack
- Python 3.10+
- PyTorch 2.4
- NumPy / SciPy / pandas
- Matplotlib
- Trimesh (3D)
- NetworkX
- SciPy spatial transforms
- CUDA AMP
